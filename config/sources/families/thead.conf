#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
# Copyright (c) 2013-2023 Jacob Hrbek, kreyren@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

# To apply generic configuration for thead family

# FIXME-QA(Krey): `source` -> `.` for more POSIXness?
# FIXME-QA(Krey): Avoid using BASH_SOURCE for more POSIXness?
source "${BASH_SOURCE%/*}/include/riscv64_common.inc"

# Bootloader
BOOTFS_TYPE="fat"
BOOTSIZE="512"

# FIXME(Krey): Declare this as generic once the project is ready
# NOTE(Krey): This is specific to TH1520, included in the board config
# BOOTSOURCE='https://github.com/chainsx/thead-u-boot'
# BOOTBRANCH='branch:extlinux'
# BOOTPATCHDIR="thead-current"
# UBOOT_TARGET_MAP=";;u-boot-with-spl.bin"

# OpenSBI
OPENSBISOURCE="https://github.com/revyos/thead-opensbi"
OPENSBIDIR="opensbi"
OPENSBIBRANCH="branch:lpi4a"
OPENSBI_USE_GCC="> 6.3"
OPENSBI_TARGET_MAP=";;build/platform/generic/firmware/fw_dynamic.bin"

# Compilers
# NOTE(Krey): Stole that from chainx's repo, context was not provided
[ -n $KERNEL_COMPILER ] || KERNEL_COMPILER="$SRC/cache/toolchain/gcc-toolchain/bin/riscv64-unknown-linux-gnu-"

[ -n $KERNEL_USE_GCC ] || KERNEL_USE_GCC="$SRC/cache/toolchain/gcc-toolchain/bin/riscv64-unknown-linux-gnu-"

[ -n $UBOOT_COMPILER ] || UBOOT_COMPILER="$SRC/cache/toolchain/gcc-toolchain/bin/riscv64-unknown-linux-gnu-"

[ -n $OPENSBI_COMPILER ] || OPENSBI_COMPILER="$SRC/cache/toolchain/gcc-toolchain/bin/riscv64-unknown-linux-gnu-"

# Family
LINUXFAMILY="thead"

# Branch-specific configuration

## NOTE(Krey): SiPeed works on official image in revyOS that is used as the kernel until the patches are mainlined
case "$BRANCH" in
	"legacy")
		case "$BOARD" in
			# The legacy kernel for LicheePi 4A is where sipeed upstream worked on mainline and so we are using their patches for compatibility
			"sipeed-licheepi-4a")
				KERNELSOURCE='https://github.com/revyos/thead-kernel'
				KERNELBRANCH="branch:lpi4a"
				KERNELPATCHDIR="thead-${BRANCH}"
				LINUXCONFIG="linux-thead-${BRANCH}"
				;;

			# Everyone else
			*)
				UBOOT_COMPILER="riscv64-linux-gnu-"
				UBOOT_USE_GCC='< 8.0'
				BOOTDIR='u-boot-thead'
				KERNELSOURCE="https://github.com/revyos/thead-kernel"
				KERNELBRANCH="branch:lpi4a"
				declare -g KERNEL_MAJOR_MINOR="5.10"
				KERNELPATCHDIR="thead-${BRANCH}"
				LINUXCONFIG="linux-thead-${BRANCH}"
		esac
		;;
	"current")
		KERNELSOURCE="https://github.com/revyos/thead-kernel"
		KERNELBRANCH="branch:lpi4a"
		KERNELPATCHDIR="thead-${BRANCH}"
		LINUXCONFIG="linux-thead-${BRANCH}"
		;;
	"edge")
		# DNM(Krey): Replace with asserting function
		echo "Edge kernel is not yet defined"
		exit 26
		;;
	*)
		# DNM(Krey): Replace with asserting function
		echo "Kernel '$BRANCH' is not implemented"
		exit 1
		;;
esac

# Power Management
GOVERNOR=performance
## FIXME-QA(Krey): Figure out the values here
## [[ -z $CPUMIN ]] && CPUMIN=480000
## [[ -z $CPUMAX ]] && CPUMAX=1010000

# Tweaks
family_tweaks() {
	display_alert "Applying family tweaks"
	case "$BOARD" in
		"sipeed-licheepi-4a")
			cp -v "$SRC/packages/blobs/riscv64/thead/light_aon_fpga.bin" "$SDCARD/boot/light_aon_fpga.bin"

			cp -v "$SRC/packages/blobs/riscv64/thead/light_c906_audio.bin" "$SDCARD/boot/light_c906_audio.bin"

			cp -v "$SRC/cache/sources/fw_dynamic.bin" "$SDCARD/boot/fw_dynamic.bin"

			case "$BRANCH" in
				"current")
					# Install a service that turns on the fan on boot to avoid overheating
					# FIXME-QA(Krey): This should be handled by sensors, provide rationale to why is this hotfix? needed
					install -m 750 "$SRC/packages/blobs/riscv64/thead/lpi4a-sysfan.sh" "$SDCARD/opt/lpi4a-sysfan.sh"

					install -m 750 "$SRC/packages/blobs/riscv64/thead/lpi4a-sysfan.service" "$SDCARD/usr/lib/systemd/system/lpi4a-sysfan.service"

					chroot "$SDCARD" /bin/bash \
						-c "systemctl --no-reload enable lpi4a-sysfan.service >/dev/null 2>&1"
					;;
			esac
			;;
		*)
			display_alert "No Family Tweaks needed"
	esac
}

write_uboot_platform() {
	case "$BOARD" in
		"sipeed-licheepi-4a")
			#dd if=$SRC/cache/sources/u-boot-with-spl.bin of=$2 bs=1024 seek=??? status=noxfer > /dev/null 2>&1
			display_alert "Installing u-boot to SD card on '$BOARD' is not implemented, fixme?"
			;;
	esac
}
